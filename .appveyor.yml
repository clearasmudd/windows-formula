---
version: '1.0.{build}'
skip_tags: true
environment:
  matrix:
    # # Linux job
    # # https://www.appveyor.com/docs/linux-images-software/
    # - job_name: Lint Tests (salt-lint, yamllint, rubocop, shellcheck, powershell-script-analyzer and commitlint)
    #   job_group: Lint Tests
    #   appveyor_build_worker_image: Ubuntu

      # Windows jobs
      # https://www.appveyor.com/docs/windows-images-software/
    - job_name: Chef Inspec Tests (Windows Server 2019)
      job_depends_on: Lint Tests
      job_group: Chef Inspec Tests
      appveyor_build_worker_image: Visual Studio 2019

    - job_name: Chef Inspec Tests (Windows Server 2016)
      job_depends_on: Lint Tests
      job_group: Chef Inspec Tests
      appveyor_build_worker_image: Visual Studio 2017

    - job_name: Chef Inspec Tests (Windows Server 2012 R2)
      job_depends_on: Lint Tests
      job_group: Chef Inspec Tests
      appveyor_build_worker_image: Visual Studio 2015

      # - job_name: On-Premise Chef Inspec Test Results (Windows 10 Build 1903)
      #   local_kitchen_suite_platform: py3-windows-10-1903
      #   job_depends_on: Chef Inspec Tests
      #   job_group: Mock Chef Inspec Tests
      #   appveyor_build_worker_image: Visual Studio 2019
      # - job_name: On-Premise Chef Inspec Test Results (Windows 10 Build 1809)
      #   local_kitchen_suite_platform: py3-windows-10-1809
      #   job_depends_on: Chef Inspec Tests
      #   job_group: Mock Chef Inspec Tests
      #   appveyor_build_worker_image: Visual Studio 2019
      # - job_name: On-Premise Chef Inspec Test Results (Windows 10 Build 1803)
      #   local_kitchen_suite_platform: py3-windows-10-1803
      #   job_depends_on: Chef Inspec Tests
      #   # job_depends_on: Lint Tests
      #   job_group: Mock Chef Inspec Tests
      #   appveyor_build_worker_image: Visual Studio 2019

      # - job_name: Release
      #   appveyor_build_worker_image: Ubuntu
      #   job_depends_on: Lint Tests, Chef Inspec Tests, Mock Chef Inspec Tests
      #   MAINTAINER_TOKEN: ${GH_TOKEN}

matrix:
  fast_finish: true

for:
  -
    matrix:
      only:
        - job_group: Lint Tests
    build_script:
      - sh: echo build_script for $APPVEYOR_JOB_NAME
      - sh: ./scripts/appveyor_tools.sh -f get-sysinfo
      - sh: PATH=$PATH:/home/appveyor/.local/bin
      - sh: ./scripts/appveyor_tools.sh -f test -i
    test_script:
      - sh: echo test_script for $APPVEYOR_JOB_NAME
      - sh: ./scripts/appveyor_tools.sh -f test -t yamllint || error=true
      - sh: ./scripts/appveyor_tools.sh -f test -t salt-lint || error=true
      - sh: ./scripts/appveyor_tools.sh -f test -t powershell-script-analyzer || error=true
      - sh: ./scripts/appveyor_tools.sh -f test -t rubocop || error=true
      - sh: ./scripts/appveyor_tools.sh -f test -t shellcheck || error=true
      - sh: ./scripts/appveyor_tools.sh -f test -t commitlint </dev/null || error=true
      - sh: ./scripts/appveyor_tools.sh -f output-sysinfo
      - sh: if [ $error ]; then exit 1; fi
      # $host.SetShouldExit(1)
    deploy: off

  -
    matrix:
      only:
        - job_depends_on: Lint Tests
    build_script:
      - ps: Write-Host "build_script for $env:APPVEYOR_JOB_NAME"
      # Saltstack needs to see the CI environment variable when run through test kitchen proxy driver
      - ps: if (Test-Path env:CI) {[System.Environment]::SetEnvironmentVariable("CI", $Env:CI, "Machine")}
      # - ps: if ($env:CI -imatch 'True') {write-host 'IS CI'} else {write-host 'IS NOT CI'}
      # - ps: ./scripts/appveyor_tools.ps1 -function sysinfo
      - ps: $ErrorActionPreference = "Stop";
      - ps: ./scripts/appveyor_tools.ps1 -function uninstall-apps-for-saltstack-testing
      - ps: ./scripts/appveyor_tools.ps1 -function setup -program test_kitchen
      - ps: c:\opscode\chefdk\bin\chef.bat exec bundle install
      - ps: c:\opscode\chefdk\bin\chef.bat exec kitchen list
      - ps: $ErrorActionPreference = "Continue";
      # - ps: if ($LastExitCode -ne 0) {write-host "last exit code $LastExitCode"; $host.SetShouldExit($LastExitCode)}

    test_script:
      - ps: Write-Host "test_script for $env:APPVEYOR_JOB_NAME"
      - ps: c:\opscode\chefdk\bin\chef.bat exec kitchen test

    deploy: off
    on_failure:
      - ps: >
          if (Test-Path "c:\temp\salt_minion.log" -PathType Leaf)
          { Get-Content "c:\temp\salt_minion.log" }
    on_finish:
      - ps: Write-Host "on_finish for $env:APPVEYOR_JOB_NAME"
      # uncomment to debug
      # - ps: ./scripts/appveyor_tools.ps1 -function setup -program rdp
      - ps: ./scripts/appveyor_tools.ps1 -function submit -results inspec_tests

  -
    matrix:
      only:
        - job_depends_on: Chef Inspec Tests
    build_script:
      - ps: Write-Host "build_script for $env:APPVEYOR_JOB_NAME"
      - ps: $ErrorActionPreference = "Stop";
      - ps: $env:local_kitchen_results = "c:\projects\windows-formula\test\results"
      - ps: $env:local_kitchen_results_log = "$env:local_kitchen_results\$env:local_kitchen_suite_platform.log"
      - ps: $env:local_kitchen_results_xml = "$env:local_kitchen_results\$env:local_kitchen_suite_platform.xml"
      - ps: >
          if (Test-Path "$env:local_kitchen_results_log" -PathType Leaf)
          { Write-Host "OUTPUTTING ON PREMISE TEST KITCHEN RESULTS FOR $env:local_kitchen_suite_platform"}
          Else { Write-Host "NO LOCAL RESULTS INCLUDED" }
      - ps: >
          if (Test-Path "$env:local_kitchen_results_log" -PathType Leaf)
          { Get-Content "$env:local_kitchen_results_log" }
      - ps: >
          if (Test-Path "$env:local_kitchen_results_xml" -PathType Leaf)
          { Copy-Item "$env:local_kitchen_results_xml" "$env:local_kitchen_results\TEST.xml" }
    test: off
    deploy: off
    on_finish:
      - ps: Write-Host "on_finish for $env:APPVEYOR_JOB_NAME"
      # uncomment to debug
      # - ps: ./scripts/appveyor_tools.ps1 -function setup -program rdp
      - ps: ./scripts/appveyor_tools.ps1 -function submit -results inspec_tests

  -
    matrix:
      only:
        - job_name: Release
    branches:
      only:
        - master
    build_script:
      - sh: echo build_script for $APPVEYOR_JOB_NAME on branch $APPVEYOR_REPO_BRANCH
      - sh: go get github.com/myii/maintainer
      - sh: maintainer contributor
      - sh: nvm current; nvm ls; nvm use 12.14.1; nvm ls
      - sh: npm i -D semantic-release
      - sh: npx semantic-release
      # - sh: npm i -D @semantic-release/changelog@3 @semantic-release/exec@3
      # @semantic-release/git@7 semantic-release@>=15.8.0
      # - sh: npx semantic-release@15.14
      # - sh: npm i
      # deploy:
      #   provider: Script
      #   sh: npx semantic-release@15.14
      #   # sh: if [ "$APPVEYOR_REPO_BRANCH" == "master" ]; then npx semantic-release@15.14; fi
    test: off
    deploy: off
